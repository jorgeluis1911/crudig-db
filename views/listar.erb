<%
paginador = ''

if (filas['filas_total'] && filas['filas_total']['0'])
  paginas = filas['filas_total']['0']['total'].to_i / tablas[tabla]['config'][:paginador]
  
  paginador = '<ul class="pagination pull-right"><li><a href="/'+tabla+'/listar">&laquo;</a></li>' if (paginas > 0)
  
  (paginas-1).times do |i|
    paginador=paginador +'<li><a href="/'+tabla+'/listar/'+(tablas[tabla]['config'][:paginador] * (i+1)).to_s+'">'+(i+2).to_s+'</a></li>'
  end 
  
  if (paginas > 0)
    paginador=paginador +'<li><a href="/'+tabla+'/listar/'+(tablas[tabla]['config'][:paginador] * paginas).to_s+'">&raquo;</a></li></ul>'
  end
end
%>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <title>CRUDig</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="/css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="/css/bootstrap_modif.css" rel="stylesheet" media="screen">
    
    <script type="text/javascript" async="" src="/js/jquery-1.10.1.min.js"></script>
    
    <script type="text/javascript" async="" src="/js/bootstrap.min.js"></script>
    
  </head>  
  <body>
    
    <div class="navbar navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">CRUDig</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <% enlaces.each do |link| %>
               <li><a href="/<%= link%>/listar"><%= link%></a></li>
            <% end %>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="navbar-right"><a href="/caracteristicas">Características</a></li>
            <li class="navbar-right"><a href="/config">Config</a></li>
            <li class="navbar-right"><a href="/config">Versiones</a></li>
            <li class="navbar-right"><a href="/graficos">Gráficos</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>    
    
      <div id="mensaje">
        <% if message != '' %>
        <div class="alert alert-success">
        	<button type="button" class="close" data-dismiss="alert">&times;</button>
        	<%= message%>
        </div>
        <% end %>
      </div>
      
      <div class="container">
        
        <div class="panel panel-default">
          <div class="panel-heading">
            <%= paginador %>
            <label class="pull-right" style="margin: 0px 15px;">Viendo desde __ a __</label>
            <label><b><%= tabla%></b></label>
          </div>
          
          <table class="table table-condensed table-bordered">
        		<thead>
          		<tr class="info">
          		  <th><a href="/<%= tabla%>/listar"><span class="glyphicon glyphicon-refresh"></span></a></th>
          		  <% tablas[tabla]['columnas'].each do |col, value| %>
                    <th><a href="/<%= tabla%>/listar?order=<%= order[:order]%>&field=<%= col%>"><%= col%>
                      <% if (order[:order] == 'desc') %>
                        <span class="glyphicon glyphicon-chevron-up"></span></a>
                      <% else %>
                        <span class="glyphicon glyphicon-chevron-down"></span></a>
                      <% end %>
                    </th>
                    <% if (value[:column_rel]) %>
                      <th><a href="/<%= tabla%>/listar?order=<%= order[:order]%>&field=<%= value[:tabla_rel]+'_'+value[:column_rel]%>">
                            <%= value[:tabla_rel]+'_'+value[:column_rel]%>
                        <% if (order[:order] == 'desc') %>
                          <span class="glyphicon glyphicon-chevron-up"></span></a>
                        <% else %>
                          <span class="glyphicon glyphicon-chevron-down"></span></a>
                        <% end %>
                      </th>
                    <% end %>
                <% end %>
          		</tr>

        		  <form action="/<%= tabla%>/listar" method="get" name="buscar" id="form_buscar1">
          			<tr>
        				  <td>
        				    <div class="btn-group">
                      <button type="button" class="btn btn-default btn-xs btn_a dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu">
                        <li role="presentation" class="dropdown-header">Refrescar cada :</li>
                        <li><a href="/refrescar/<%= tabla%>/10">10 seg</a></li>
                        <li><a href="/refrescar/<%= tabla%>/15">15 seg</a></li>
                        <li><a href="/refrescar/<%= tabla%>/20">20 seg</a></li>
                        <li><a href="/refrescar/<%= tabla%>/25">25 seg</a></li>
                        <li><a href="/refrescar/<%= tabla%>/0">Quitar</a></li>
                        <li><a href="/refrescar/<%= tabla%>">Quitar todos</a></li>
                      </ul>
                    </div>
          				  <a href="" class="btn btn-default btn-xs btn_a" 
          				    data-toggle="modal" data-target="#agregarfila" onclick="agregar()">
          				      <span class="glyphicon glyphicon-plus"></span>
          				  </a>
          				  <a href="/<%= tabla%>" class="btn btn-default btn-xs btn_a" onclick="javascript:document.forms[0].submit();">
          				    <span class="glyphicon glyphicon-search"></span>
          				  </a>
          				  <input type="submit" class="btn btn-default btn-xs btn_a glyphicon glyphicon-search" value=""/>
        					<!--<td><input type="submit" value="Add"/>
        					     <input type="submit" value="Search"/> -->
        					</td>
        					<% tablas[tabla]['columnas'].each do |col, value| %>
          					  <td>
          					  <% if (value[:column_rel]) %>
            					    <select class="form-control" id="<%= col%>" name="<%= col%>" >
            					      <option value="">-Todos-</option>
            					      <% filas[value[:tabla_rel]].each do |id, fila| %>
                					      <option value="<%= fila[value[:column_rel]]%>" 
                					        <%= 'selected' if (params[col].eql?(fila[value[:column_rel]]))%> >
                					        <%= fila[value[:column_rel]]%></option>
            					      <% end %>
            					    </select>
            					  </td>
            					  <td>
                          <input type="search" class="form-control"
                              id="<%= value[:tabla_rel]+'_'+value[:column_rel]%>" 
                              name="<%= value[:tabla_rel]+'_'+value[:column_rel]%>" 
                              value="<%= params[value[:tabla_rel]+'_'+value[:column_rel]] %>" />
          					  <% else %>
                        <input type="search" id="<%= col%>" name="<%= col%>" value="<%= params[col]%>" class="form-control"/>
                      <% end %>
                      </td>
                  <% end %>
          			</tr>
          		</form>	
        		</thead>
            <tbody>
        			<% filas[tabla].each do |key, en| %>
        			  <tr id="<%= key%>">
        			    <td>
        			      <div class="btn-group">
                      <button type="button" class="btn btn-default btn-xs btn_a dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a href="" data-toggle="modal" data-target="#editarfila" >
                            Editar en ventana</a>
                        </li>
                        <%  ids = ''
                          en.each do |col, valor| 
                            if (tablas[tabla]['columnas'][col] && tablas[tabla]['columnas'][col][:column_key]=='PRI')
                              if(ids.eql? '')
                                ids = ids+col.to_s+'='+valor.to_s
                              else
                                ids = ids+'&'+col.to_s+'='+valor.to_s
                              end
                            end
                          end
                        %>
                        <li><a href="/jerarquiaUp/<%= (tabla+'?'+ids) %>" target="_blank">Jerarquía hacia arriba</a></li>
                        <li><a href="/jerarquiaDown/<%= (tabla+'?'+ids) %>" target="_blank">Jerarquía hacia abajo</a></li>
                      </ul>
                    </div>
                    
          				  <a href="/<%= tabla%>/<%= key%>" class="btn btn-default btn-xs btn_a"
          				    onclick="before_update('<%= key%>'); return false;">
          				    <span class="glyphicon glyphicon-pencil"></span></a>
          				  <a href="/<%= tabla%>/<%= key%>" class="btn btn-default btn-xs btn_a"
          				    onclick="cancel_update('<%= key%>'); return false;">
                      <span class="glyphicon glyphicon-remove"></a>
          					<!--<form action="/<%= tabla%>/<%= key%>" method="post">
          						<input type="hidden" name="_method" value="delete" />
          						<input type="submit" value="Delete" class="btn btn-default"/>
          					</form>-->
          				</td>
          				<% en.each do |col, valor| %>
        				    <td><% if (tablas[tabla]['columnas'][col] && tablas[tabla]['columnas'][col][:column_rel]) %>
        				          <a href="/<%= tablas[tabla]['columnas'][col][:tabla_rel]%>/listar?<%= col+'='+valor%>"><%= valor%></a>
        				        <% else %>
        				          <%= valor%></td>
        				        <% end %>
        				  <% end %>
        			  </tr>
        			<% end %>  			  
        		</tbody>
        	</table> 
        	<%= '<div class="alert alert-danger"> No tiene datos está tabla </div>' if (filas[tabla].length < 1) %>
        	<%#= tablas[tabla]['columnas']  	
        	%>
        	<%#= filas 
        	%>
        	
<!--        	<div class="panel-footer">
        	  <%#= paginador 
        	  %>
            <label>Viendo desde __ a __</label>
   </div>-->
        </div>
      

        <!-- Grid detalle -->
        <ul class="nav nav-tabs" id="detalle_grid">
        <% tablas[tabla]['config'][:referidas].each do |tabla_ref| %>
            <li><a href="#<%= tabla_ref%>" data-toggle="tab"><%= tabla_ref%></a></li>          
        <% end %>
        </ul>
   <!--       <div class="tab-content">
            <div class="tab-pane active" id="home"> 
            <div class="tab-pane" id="profile"><p>asdasdasd wwwww</p></div>
            <div class="tab-pane" id="messages"><p>asdasdasd ****** </p></div>
            <div class="tab-pane" id="settings"><p>asdasdasd ________  aaaaa</p></div>
          </div>  -->
        
        <% #if (tablas[tabla]['config'][:detalle_de] != '') 
            #tabla_detalle = tablas[tabla]['config'][:detalle_de]
            #puts tablas[tabla]['config'][:referidas]
            #puts tablas['dept_emp']
=begin            
  dept_emp
  dept_manager
  salaries
  titles
=end
        %>
        
        <div class="tab-content">
          <%  referencias = {}
=begin              if (tablas[tabla]['config'][:referidas].length > 1)
                referencias = tablas[tabla]['config'][:referidas]
              else
                referencias = tablas[tabla]['config'][:detalle_de]
              end
=end             
              referencias = tablas[tabla]['config'][:referidas] 
          %>
          <% referencias.each do |tabla_detalle|  %>  
            <div class="tab-pane active" id="<%= tabla_detalle %>">  
              <div class="panel panel-default">
                <div class="panel-heading">
                  <%= paginador %>
                  <label><b><%= tabla_detalle %></b></label>
                </div>
                
                <table class="table table-condensed table-bordered">
                  <thead>
                    <tr class="info">
                      <th><a href="/<%= tabla%>/listar"><span class="glyphicon glyphicon-refresh"></span></a></th>
                      <% tablas[tabla_detalle]['columnas'].each do |col, value| %>
                        <th><a href="/<%= tabla%>/listar?g_o=<%= order[:grid2_order]%>&g_f=<%= col%>&g_g=<%= tabla_detalle%>"><%= col%>
                          <% if (order[:grid2_order] == 'desc') %>
                            <span class="glyphicon glyphicon-chevron-up"></span></a>
                          <% else %>
                            <span class="glyphicon glyphicon-chevron-down"></span></a>
                          <% end %>
                        </th>
                        <% if (value[:column_rel]) %>
                          <th><a href="/<%= tabla%>/listar?g_o=<%= order[:grid2_order]%>&g_f=<%= value[:tabla_rel]+'_'+value[:column_rel]%>&g_g=<%= tabla_detalle%>">
                                <%= value[:tabla_rel]+'_'+value[:column_rel]%>
                            <% if (order[:grid2_order] == 'desc') %><span class="glyphicon glyphicon-chevron-up"></span></a>
                            <% else %>                <span class="glyphicon glyphicon-chevron-down"></span></a>
                            <% end %>
                          </th>
                        <% end %>
                      <% end %>
                    </tr>

                    <form action="/<%= tabla_detalle%>/listar" method="get" name="buscar" id="form_buscar2_<%= tabla_detalle%>">
                      <tr>
                        <td>                          
                          <a href="" class="btn btn-default btn-xs btn_a" 
                            data-toggle="modal" data-target="#agregarfila" onclick="agregar()">
                              <span class="glyphicon glyphicon-plus"></span>
                          </a>
                          <a href="/<%= tabla_detalle%>" class="btn btn-default btn-xs btn_a" onclick="javascript:document.forms[0].submit();">
                            <span class="glyphicon glyphicon-search"></span>
                          </a>
                          <input type="submit" class="btn btn-default btn-xs btn_a glyphicon glyphicon-search" value="" 
                              onclick="buscar_tabs('form_buscar2_<%= tabla_detalle%>'); return false;"/>
                        <!--<td><input type="submit" value="Add"/>
                             <input type="submit" value="Search"/> -->
                        </td>
                        <% tablas[tabla_detalle]['columnas'].each{ |col, value| %>
                            <td>
                            <% if (value[:column_rel]) %>
                              <% if (filas[value[:tabla_rel]]) %>
                                <select class="form-control" id="<%= col%>" name="<%= col%>" >
                                  <option value="">-Todos-</option>
                                  <% filas[value[:tabla_rel]].each do |id, fila| %>
                                      <option value="<%= fila[value[:column_rel]]%>" 
                                        <%= 'selected' if (params[col].eql?(fila[value[:column_rel]]))%> >
                                        <%= fila[value[:column_rel]]%></option>
                                  <% end %>
                                </select>
                              <% else %>
                                <input type="search" id="<%= col%>" name="<%= col%>" value="<%= params[col]%>" class="form-control"/>
                              <% end %>
                              </td>
                              <td>
                                <input type="search" class="form-control"
                                    id="<%= value[:tabla_rel]+'_'+value[:column_rel]%>" 
                                    name="<%= value[:tabla_rel]+'_'+value[:column_rel]%>" 
                                    value="<%= params[value[:tabla_rel]+'_'+value[:column_rel]] %>" />
                            <% else %>
                              <input type="search" id="<%= col%>" name="<%= col%>" value="<%= params[col]%>" class="form-control"/>
                            <% end %>
                            </td>
                        <%  } %>
                      </tr>
                    </form>
                  </thead>
                  <tbody>                    
                    <%#= filas[:filas_detalle] 
                    %>
                    <%  filas_detalle = {}
                        if (filas[:filas_detalle][tabla_detalle])
                        #if (filas[tabla_detalle])
                          filas_detalle = filas[:filas_detalle][tabla_detalle][tabla_detalle]
                        end 
                    %>
                    <% filas_detalle.each do |key, en| %>
                      <tr id="<%= key%>">
                        <td>
                          <div class="btn-group">
                            <button type="button" class="btn btn-default btn-xs btn_a dropdown-toggle" data-toggle="dropdown">
                              <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                              <li><a href="" data-toggle="modal" data-target="#editarfila" >
                                  Editar en ventana</a>
                              </li>
                              <%  ids = ''
                                en.each do |col, valor| 
                                  if (tablas[tabla_detalle]['columnas'][col] && tablas[tabla_detalle]['columnas'][col][:column_key]=='PRI')
                                    if(ids.eql? '')
                                      ids = ids+col.to_s+'='+valor.to_s
                                    else
                                      ids = ids+'&'+col.to_s+'='+valor.to_s
                                    end
                                  end
                                end
                              %>
                              <li><a href="/jerarquiaUp/<%= (tabla_detalle+'?'+ids) %>" target="_blank">
                                Jerarquía hacia arriba</a></li>
                              <li><a href="/jerarquiaDown/<%= (tabla_detalle+'?'+ids) %>" target="_blank">
                                Jerarquía hacia abajo</a></li>
                            </ul>
                          </div>
                          
                          <a href="/<%= tabla_detalle %>/<%= key %>" class="btn btn-default btn-xs btn_a"
                            onclick="before_update('<%= key%>'); return false;">
                            <span class="glyphicon glyphicon-pencil"></span></a>
                          <a href="/<%= tabla_detalle %>/<%= key %>" class="btn btn-default btn-xs btn_a"
                            onclick="cancel_update('<%= key %>'); return false;">
                            <span class="glyphicon glyphicon-trash"></a>
                          <!--<form action="/<%= tabla%>/<%= key%>" method="post">
                            <input type="hidden" name="_method" value="delete" />
                            <input type="submit" value="Delete" class="btn btn-default"/>
                          </form>-->
                        </td>
                        <% en.each do |col, valor| %>
                          <td><% if (tablas[tabla_detalle]['columnas'][col] && tablas[tabla_detalle]['columnas'][col][:column_rel]) %>
                                <a href="/<%= tablas[tabla_detalle]['columnas'][col][:tabla_rel]%>/listar?<%= col+'='+valor%>"><%= valor%></a>
                              <% else %>
                                <%= valor%></td>
                              <% end %>
                        <% end %>
                      </tr>
                    <% end %>   
                  </tbody>
                </table>
              </div>
              
            </div>
          <% end %>
        </div>
      </div> 

              
      <!-- Modal Agregar-->
      
      <div class="modal fade" id="agregarfila" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h4 class="modal-title" id="myModalLabel">Nuevo registro de <%= tabla%></h4>
            </div>
            <div class="modal-body">
              <form action="/<%= tabla%>/create_json" method="get" id="agregarform" name="agregarform" 
                  class="form-horizontal" role="form">
                    <% tablas[tabla]['columnas'].each do |col, value| %>
                    <div class="form-group">
                      <label for="<%= col%>" class="col-sm-2 control-label"><%= col%></label>
                      <div class="col-sm-10">
                      <% if (value[:column_rel]) %>
                          <select class="form-control" id="<%= col%>" name="<%= col%>" required>
                            <% filas[value[:tabla_rel]].each do |id, fila| %>
                                <option value="<%= fila[value[:column_rel]]%>" 
                                  <%= 'selected' if (params[col].eql?(fila[value[:column_rel]]))%> >
                                  <%= fila[value[:column_rel]]%></option>
                            <% end %>
                          </select>
                      <% else %>
                        <input type="search" id="<%= col%>" name="<%= col%>" value="<%= params[col]%>" 
                            maxlength="<%= value[:length] if value[:length]%>" class="form-control"
                            <%= 'required' if value[:column_key]=='PRI' %>/>
                      <% end %>
                      </div>
                    </div>
                    <% end %>
                <br />
      
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <input type="submit" name="agregarbtn" class="btn btn-info" value="Crear Nuevo">
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modal Editar-->
      
      <div class="modal fade" id="editarfila" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" style="width: 600px;">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              <h4 class="modal-title" id="myModalLabel">Nuevo registro de <%= tabla%></h4>
            </div>
            <div class="modal-body">
              <form action="/<%= tabla%>/update_id_json" method="get" id="editarform" name="editarform" 
                  class="form-horizontal" role="form">
                    <% tablas[tabla]['columnas'].each do |col, value| %>
                    <div class="form-group">
                      <label for="inputEmail3" class="col-sm-2 control-label">Email</label>
                      <div class="col-sm-10">
                      <% if (value[:column_rel]) %>
                          <select class="form-control" id="<%= col%>" name="<%= col%>" >
                            <% filas[value[:tabla_rel]].each do |id, fila| %>
                                <option value="<%= fila[value[:column_rel]]%>" 
                                  <%= 'selected' if (params[col].eql?(fila[value[:column_rel]]))%> >
                                  <%= fila[value[:column_rel]]%></option>
                            <% end %>
                          </select>
                      <% else %>
                        <input type="search" id="<%= col%>" name="<%= col%>" value="<%= params[col]%>" 
                            maxlength="<%= value[:length] if value[:length]%>" class="form-control"/>
                      <% end %>
                      </div>
                    </div>
                    <% end %>
                <br />
      
                <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                <input type="submit" name="editarbtn" class="btn btn-info" value="Guardar Cambios">
              </form>
            </div>
          </div>
        </div>
      </div>
            

      <script>
      
        <% if (timers[tabla]) 
              segundos = timers[tabla][:segundos].to_i
              segundos = 15 if (segundos.eql? '' || segundos < 50)
        %>
          <%= 'setTimeout("location.reload(true);",'+segundos.to_s+'000);' %>
          <%#= 'timeRefreshPage('+timers[tabla]+');'
          %>
        <% end %>      
      
      
        $("#agregarform").submit(function( event ) {
          // Stop form from submitting normally
          event.preventDefault();
         
          // Get some values from elements on the page:
          var $form = $( this ),
            term = $form.serialize(),
            url = $form.attr( "action" );
         
          // Send the data using post
          $.getJSON( url, term )         
              .done(function( json ) {
                //var content = $(data).find("#content");
                //if (json["valido"] == 1) {
                if (json.valido == '1') {
                  $("#mensaje").empty().append('<div class="alert alert-success">'+
                    '<button type="button" class="close" data-dismiss="alert">&times;</button>'+json.mensaje+'</div>');
                }else{
                  $("#mensaje").empty().append('<div class="alert alert-danger">'+
                    '<button type="button" class="close" data-dismiss="alert">&times;</button>'+json.mensaje+'</div>');
                }
              })
              .fail(function( jqxhr, textStatus, error ) {
                $("#mensaje").empty().append('<div class="alert alert-danger">'+
              '<button type="button" class="close" data-dismiss="alert">&times;</button>'+textStatus+", "+error+'</div>');
          });
          $("#agregarfila").modal('hide');
          return false;
        });  
        
        function before_update(id){
          var cells = document.getElementById(id).getElementsByTagName('td');
          
          for(var i=1; i<cells.length-1; i+=1){
            cells[i].innerHTML = '<input type="text" id="" name="" class="form-control" value="'+cells[i].innerHTML+'"/>';
          }    
        }
        
        function final_update(id){
      
        }
        
        function cancel_update(id){
          var cells = document.getElementById(id).getElementsByTagName('td');
          
          for(var i=1; i<cells.length-1; i+=1){
            cells[i].innerHTML = cells[i].firstChild.value;
          }    
        }  
        
        function agregar(){
          
        }
        
        $(function () {
          tab = '<%= params[:g_g]%>';
          
          if (tab == '') $('#detalle_grid a:first').tab('show')
          else           $('#detalle_grid a[href="#<%= params[:g_g]%>"]').tab('show')
        })
        
        
        //  funciones grids tabs
        
        function buscar_tabs( form_id ){
          var url = $( "#"+form_id ).attr('action');
                    
          var jqxhr = $.post( url, $( "#"+form_id ).serialize())
            .done(function( hash_json ) {
              alert( "success - "+ form_id +' - '+ url +'?'+  $( "#"+form_id ).serialize() );
              alert( hash_json );
            })
            .fail(function() {
              //alert( ".No se puede realizar la busqueda ahroa." );
              alert( url +'?'+  $( "#"+form_id ).serialize());
            });
          event.preventDefault();
          return false;
        }

      </script>
      
  </body>
</html>