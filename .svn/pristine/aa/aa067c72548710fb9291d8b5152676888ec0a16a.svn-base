class App < Sinatra::Application
  
  get '/entornos' do
    (params[:order]) ? order = params[:order] : order = 'asc'
    field = params[:field]
    
    ordenar(field,order)
    #erb :listar, :locals => {:entornos => @@entornos, :message => message}
    (order=='asc') ? order='desc' : order='asc'
    listar('', order)
  end
  
  get '/entorno' do
    erb :agregar
  end
  
  post '/entorno' do
    @@entornos << Entorno.new(params) if params[:compania]
    listar 'Entorno nuevo agregado correctamente'
  end
  
  get '/entorno/:ids' do |ids|
    en = @@entornos.select{ |en1| en1.id.to_s == ids }
    erb :modificar, :locals => {:en => en[0]}
  end
  
  put '/entorno/:ids' do |ids|
    @@entornos.each_index do |x|
      if (params[:compania] && params[:nombre])
        @@entornos[x].update(params) if @@entornos[x].id.to_s == ids
      end
    end
    listar 'Entorno editado correctamente'
  end
    
  delete '/entorno/:ids' do |ids| 
    if (params[:del1])
      @@entornos.each_index do |x|
          @@entornos.delete_at(x) if @@entornos[x].id.to_s == ids
      end
      listar 'Entorno eliminado correctamente'
    else
      en = @@entornos.select{ |en1| en1.id.to_s == ids }
      erb :delete, :locals => {:en => en[0]}
    end
  end
  
  def listar(message='',order='')
    erb :listar, :locals => {:entornos => @@entornos, :message => message, :order => order}
  end
  
  def ordenar(field='', order='')
    if (order=='asc')
      case field
      when 'compania' then @@entornos.sort! { |a,b| a.compania.downcase <=> b.compania.downcase }
      when 'bd' then       @@entornos.sort! { |a,b| a.bd.downcase <=> b.bd.downcase }
      when 'url' then      @@entornos.sort! { |a,b| a.url.downcase <=> b.url.downcase }
      when 'svn' then      @@entornos.sort! { |a,b| a.svn.downcase <=> b.svn.downcase }
      when 'nom' then      @@entornos.sort! { |a,b| a.nombre.downcase <=> b.nombre.downcase }
      else ''
      end
    elsif (order=='desc')
      case field
      when 'compania' then @@entornos.sort! { |a,b| b.compania.downcase <=> a.compania.downcase }
      when 'bd' then       @@entornos.sort! { |a,b| b.bd.downcase <=> a.bd.downcase }
      when 'url' then      @@entornos.sort! { |a,b| b.url.downcase <=> a.url.downcase }
      when 'svn' then      @@entornos.sort! { |a,b| b.svn.downcase <=> a.svn.downcase }
      when 'nom' then      @@entornos.sort! { |a,b| b.nombre.downcase <=> a.nombre.downcase }
      else ''
      end
    end
  end
  
end
